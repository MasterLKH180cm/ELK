input {
  # HTTP endpoint for REST API logs
  http {
    port => 8081
    codec => json
    # Add these lines for CORS
    response_headers => {
      "Access-Control-Allow-Origin" => "*"
      "Access-Control-Allow-Headers" => "Content-Type"
      "Access-Control-Allow-Methods" => "POST, OPTIONS"
    }
  }

  # TCP endpoint for general logs
  tcp {
    port => 5000
    codec => json
  }

  # Beats input (Filebeat, Metricbeat, etc.)
  beats {
    port => 5044
  }
}

filter {
  # @timestamp is already in the logs, but ensure proper format
  if [@timestamp] {
    date {
      match => ["@timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # Extract log type from nested field
  if [log][type] {
    mutate {
      add_field => { "log_type" => "%{[log][type]}" }
    }
  }

  # Separate pipelines by log type
  if [log][type] == "fastapi" {
    mutate { add_field => { "log_category" => "fastapi" } }
    
    # Convert event.duration from nanoseconds to milliseconds
    if [event][duration] {
      ruby {
        code => '
          duration_ns = event.get("[event][duration]")
          if duration_ns
            duration_ms = duration_ns / 1_000_000.0
            event.set("response_time_ms", duration_ms)
            
            # Add latency category based on milliseconds
            case duration_ms
            when 0..200 then event.set("latency_category", "fast")
            when 200..500 then event.set("latency_category", "moderate")
            else event.set("latency_category", "slow")
            end
          end
        '
      }
    }
    
    # Extract HTTP fields for easier querying
    if [http][request][method] {
      mutate { add_field => { "http_method" => "%{[http][request][method]}" } }
    }
    if [http][response][status_code] {
      mutate { add_field => { "http_status" => "%{[http][response][status_code]}" } }
    }
    if [url][path] {
      mutate { add_field => { "url_path" => "%{[url][path]}" } }
    }
    if [client][ip] {
      mutate { add_field => { "client_ip" => "%{[client][ip]}" } }
    }
    
  } else if [log][type] == "postgres" {
    mutate { add_field => { "log_category" => "postgres" } }
    
    # Convert event.duration from nanoseconds to milliseconds
    if [event][duration] {
      ruby {
        code => '
          duration_ns = event.get("[event][duration]")
          if duration_ns
            duration_ms = duration_ns / 1_000_000.0
            event.set("query_time_ms", duration_ms)
          end
        '
      }
    }
    
    # Extract database fields
    if [db][statement] {
      mutate { add_field => { "db_statement" => "%{[db][statement]}" } }
    }
    if [user][name] {
      mutate { add_field => { "db_user" => "%{[user][name]}" } }
    }
    
  } else if [log][type] == "redis" {
    mutate { add_field => { "log_category" => "redis" } }
    
    # Convert event.duration from nanoseconds to milliseconds
    if [event][duration] {
      ruby {
        code => '
          duration_ns = event.get("[event][duration]")
          if duration_ns
            duration_ms = duration_ns / 1_000_000.0
            event.set("operation_time_ms", duration_ms)
          end
        '
      }
    }
    
    # Extract Redis fields
    if [redis][action] {
      mutate { add_field => { "redis_action" => "%{[redis][action]}" } }
    }
    if [redis][key] {
      mutate { add_field => { "redis_key" => "%{[redis][key]}" } }
    }
  }
  
  # Extract common fields for all log types
  if [log][level] {
    mutate { add_field => { "log_level" => "%{[log][level]}" } }
  }
  if [process][pid] {
    mutate { add_field => { "process_id" => "%{[process][pid]}" } }
  }
}

output {
  if [log][type] == "fastapi" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "password"
      data_stream => true
      data_stream_namespace => "default"
      data_stream_dataset => "fastapi"
    }
  } else if [log][type] == "redis" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "password"
      data_stream => true
      data_stream_namespace => "default"
      data_stream_dataset => "redis"
    }
  }  else if [log][type] == "postgres" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "password"
      data_stream => true
      data_stream_namespace => "default"
      data_stream_dataset => "postgres"
    }
  } else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "password"
      data_stream => true
      data_stream_namespace => "default"
      data_stream_dataset => "others"
    }
  }

  stdout { codec => rubydebug }
}

